pipeline {
    agent any
    
    environment {
        // ========== CONFIGURE THESE ==========
        DOCKER_REGISTRY = 'docker.io'  // or 'ghcr.io' for GitHub Container Registry
        DOCKER_USERNAME = credentials('docker-hub-username')  // Store in Jenkins credentials
        DOCKER_PASSWORD = credentials('docker-hub-password')
        DOCKER_REPO = 'yourdockerhubusername'  // Your Docker Hub username
        APP_VERSION = "${BUILD_NUMBER}"
        
        // Voting App specific
        VOTE_APP_IMAGE = "${DOCKER_REPO}/example-voting-app-vote:${APP_VERSION}"
        RESULT_APP_IMAGE = "${DOCKER_REPO}/example-voting-app-result:${APP_VERSION}"
        WORKER_APP_IMAGE = "${DOCKER_REPO}/example-voting-app-worker:${APP_VERSION}"
        
        // Kubernetes/ArgoCD
        ARGOCD_SERVER = 'argocd.yourdomain.com'  // Your ArgoCD server URL
        ARGOCD_APP_NAME = 'voting-app'
        ARGOCD_PROJECT = 'default'
        GITOPS_REPO = 'https://github.com/yourusername/voting-app-gitops.git'  // Your GitOps repo
    }
    
    stages {
        // ========== STAGE 1: CHECKOUT CODE ==========
        stage('Checkout Source Code') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Praveena0308/example-voting-app.git',
                        credentialsId: 'github-credentials'  // Optional: if private repo
                    ]]
                ])
                sh 'ls -la'  // Verify checkout
            }
        }
        
        // ========== STAGE 2: LOGIN TO DOCKER REGISTRY ==========
        stage('Docker Login') {
            steps {
                sh """
                    docker login ${DOCKER_REGISTRY} \
                    -u ${DOCKER_USERNAME} \
                    -p ${DOCKER_PASSWORD}
                """
            }
        }
        
        // ========== STAGE 3: BUILD DOCKER IMAGES ==========
        stage('Build Images') {
            parallel {
                stage('Build Vote App') {
                    steps {
                        dir('vote') {
                            sh "docker build -t ${VOTE_APP_IMAGE} ."
                        }
                    }
                }
                stage('Build Result App') {
                    steps {
                        dir('result') {
                            sh "docker build -t ${RESULT_APP_IMAGE} ."
                        }
                    }
                }
                stage('Build Worker App') {
                    steps {
                        dir('worker') {
                            sh "docker build -t ${WORKER_APP_IMAGE} ."
                        }
                    }
                }
            }
        }
        
        // ========== STAGE 4: PUSH IMAGES ==========
        stage('Push Images') {
            parallel {
                stage('Push Vote Image') {
                    steps {
                        sh "docker push ${VOTE_APP_IMAGE}"
                    }
                }
                stage('Push Result Image') {
                    steps {
                        sh "docker push ${RESULT_APP_IMAGE}"
                    }
                }
                stage('Push Worker Image') {
                    steps {
                        sh "docker push ${WORKER_APP_IMAGE}"
                    }
                }
            }
        }
        
        // ========== STAGE 5: UPDATE GITOPS REPO ==========
        stage('Update GitOps Repository') {
            steps {
                script {
                    // Clone your GitOps repo (where K8s manifests are stored)
                    sh """
                        git clone ${GITOPS_REPO} gitops-temp
                        cd gitops-temp
                        
                        # Update image tags in Kubernetes manifests
                        # Method 1: Using sed (simple replacement)
                        sed -i 's|yourdockerhubusername/example-voting-app-vote:.*|${VOTE_APP_IMAGE}|g' k8s-manifests/vote-deployment.yaml
                        sed -i 's|yourdockerhubusername/example-voting-app-result:.*|${RESULT_APP_IMAGE}|g' k8s-manifests/result-deployment.yaml
                        sed -i 's|yourdockerhubusername/example-voting-app-worker:.*|${WORKER_APP_IMAGE}|g' k8s-manifests/worker-deployment.yaml
                        
                        # Commit and push the changes
                        git config user.email "jenkins@example.com"
                        git config user.name "Jenkins"
                        git add .
                        git commit -m "Update voting app images to version ${APP_VERSION}"
                        git push origin main
                        
                        # Clean up
                        cd ..
                        rm -rf gitops-temp
                    """
                    
                    // Alternative: Use ArgoCD CLI to sync (if you have argocd CLI installed)
                    // sh "argocd app set ${ARGOCD_APP_NAME} --image ${VOTE_APP_IMAGE}"
                    // sh "argocd app sync ${ARGOCD_APP_NAME}"
                }
            }
        }
        
        // ========== STAGE 6: TRIGGER ARGOCD SYNC ==========
        stage('Trigger ArgoCD Sync') {
            steps {
                script {
                    // Method A: Webhook (Recommended - ArgoCD auto-syncs on repo change)
                    echo "ArgoCD will automatically detect GitOps repo changes and sync"
                    
                    // Method B: Using curl to trigger ArgoCD webhook (if configured)
                    // sh """
                    //     curl -X POST ${ARGOCD_SERVER}/api/webhook \
                    //     -H "Content-Type: application/json"
                    // """
                    
                    // Method C: Using argocd CLI (requires CLI setup)
                    // withCredentials([string(credentialsId: 'argocd-token', variable: 'ARGOCD_TOKEN')]) {
                    //     sh """
                    //         argocd login ${ARGOCD_SERVER} --auth-token ${ARGOCD_TOKEN}
                    //         argocd app sync ${ARGOCD_APP_NAME}
                    //         argocd app wait ${ARGOCD_APP_NAME} --health
                    //     """
                    // }
                }
            }
        }
    }
    
    // ========== POST-BUILD ACTIONS ==========
    post {
        success {
            echo "✅ Pipeline succeeded! New images:"
            echo "Vote: ${VOTE_APP_IMAGE}"
            echo "Result: ${RESULT_APP_IMAGE}"
            echo "Worker: ${WORKER_APP_IMAGE}"
            echo "ArgoCD will deploy these to Kubernetes automatically"
        }
        failure {
            echo "❌ Pipeline failed. Check logs above."
        }
        always {
            // Clean up Docker credentials
            sh 'docker logout'
            cleanWs()  // Clean workspace
        }
    }
}