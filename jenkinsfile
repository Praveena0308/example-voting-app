pipeline {
    agent any
    
    environment {
        // Your Docker Hub username (from Jenkins credentials)
        DOCKER_REPO = 'pravee033'  // CHANGE THIS to your actual username
        
        // GitOps repository URL
        GITOPS_REPO = 'https://github.com/YOUR_USERNAME/voting-app-gitops.git'  // CHANGE THIS
        
        // Image tags with build number
        TAG = "build-${BUILD_NUMBER}"
        VOTE_IMAGE = "${DOCKER_REPO}/example-voting-app-vote:${TAG}"
        RESULT_IMAGE = "${DOCKER_REPO}/example-voting-app-result:${TAG}"
        WORKER_IMAGE = "${DOCKER_REPO}/example-voting-app-worker:${TAG}"
    }
    
    stages {
        // ========== STAGE 1: CHECKOUT VOTING APP CODE ==========
        stage('Checkout Voting App') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Praveena0308/example-voting-app.git'
                        // No credentials needed - it's a public repo
                    ]]
                ])
                sh 'echo "‚úÖ Code checked out successfully"'
            }
        }
        
        // ========== STAGE 2: LOGIN TO DOCKER HUB ==========
        stage('Docker Login') {
            steps {
                // Using credentials from Jenkins UI
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-hub-credentials',  // CHANGE to your credential ID
                        usernameVariable: 'DOCKER_USERNAME',
                        passwordVariable: 'DOCKER_PASSWORD'
                    )
                ]) {
                    sh """
                        echo "Logging into Docker Hub as \${DOCKER_USERNAME}..."
                        docker login -u \${DOCKER_USERNAME} -p \${DOCKER_PASSWORD}
                    """
                }
            }
        }
        
        // ========== STAGE 3: BUILD DOCKER IMAGES ==========
        stage('Build Images') {
            parallel {
                stage('Build Vote App') {
                    steps {
                        dir('vote') {
                            sh """
                                echo "Building vote image..."
                                docker build -t ${VOTE_IMAGE} .
                            """
                        }
                    }
                }
                stage('Build Result App') {
                    steps {
                        dir('result') {
                            sh """
                                echo "Building result image..."
                                docker build -t ${RESULT_IMAGE} .
                            """
                        }
                    }
                }
                stage('Build Worker App') {
                    steps {
                        dir('worker') {
                            sh """
                                echo "Building worker image..."
                                docker build -t ${WORKER_IMAGE} .
                            """
                        }
                    }
                }
            }
        }
        
        // ========== STAGE 4: PUSH IMAGES TO DOCKER HUB ==========
        stage('Push Images') {
            parallel {
                stage('Push Vote Image') {
                    steps {
                        sh """
                            echo "Pushing ${VOTE_IMAGE}..."
                            docker push ${VOTE_IMAGE}
                        """
                    }
                }
                stage('Push Result Image') {
                    steps {
                        sh """
                            echo "Pushing ${RESULT_IMAGE}..."
                            docker push ${RESULT_IMAGE}
                        """
                    }
                }
                stage('Push Worker Image') {
                    steps {
                        sh """
                            echo "Pushing ${WORKER_IMAGE}..."
                            docker push ${WORKER_IMAGE}
                        """
                    }
                }
            }
        }
        
        // ========== STAGE 5: UPDATE GITOPS REPOSITORY ==========
        stage('Update GitOps Manifests') {
            steps {
                // Using Git credentials from Jenkins UI
                withCredentials([
                    usernamePassword(
                        credentialsId: 'github-credentials',  // CHANGE to your git credential ID
                        usernameVariable: 'GIT_USERNAME',
                        passwordVariable: 'GIT_PASSWORD'
                    )
                ]) {
                    script {
                        sh """
                            echo "Cloning GitOps repository..."
                            # Clone using HTTPS with credentials
                            git clone https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/YOUR_USERNAME/voting-app-gitops.git gitops-update
                            
                            cd gitops-update
                            
                            echo "Updating Kubernetes manifests with new image tags..."
                            
                            # Update vote-app.yaml
                            if [ -f "vote-app.yaml" ]; then
                                sed -i 's|dockersamples/examplevotingapp_vote:.*|${VOTE_IMAGE}|g' vote-app.yaml
                                echo "‚úÖ Updated vote-app.yaml"
                            else
                                echo "‚ö†Ô∏è vote-app.yaml not found"
                            fi
                            
                            # Update result-app.yaml
                            if [ -f "result-app.yaml" ]; then
                                sed -i 's|dockersamples/examplevotingapp_result:.*|${RESULT_IMAGE}|g' result-app.yaml
                                echo "‚úÖ Updated result-app.yaml"
                            else
                                echo "‚ö†Ô∏è result-app.yaml not found"
                            fi
                            
                            # Update worker-app.yaml
                            if [ -f "worker-app.yaml" ]; then
                                sed -i 's|dockersamples/examplevotingapp_worker:.*|${WORKER_IMAGE}|g' worker-app.yaml
                                echo "‚úÖ Updated worker-app.yaml"
                            else
                                echo "‚ö†Ô∏è worker-app.yaml not found"
                            fi
                            
                            # Configure git
                            git config user.email "jenkins@yourcompany.com"
                            git config user.name "Jenkins CI"
                            
                            # Commit changes
                            git add .
                            git commit -m "Deploy voting app version ${BUILD_NUMBER}" || echo "No changes to commit"
                            
                            # Push changes
                            git push origin main
                            
                            echo "‚úÖ GitOps repository updated successfully!"
                        """
                    }
                }
            }
        }
        
        // ========== STAGE 6: NOTIFY SUCCESS ==========
        stage('Deployment Complete') {
            steps {
                echo """
                üéâ CI/CD Pipeline Successful!
                
                Docker Images Published:
                - ${VOTE_IMAGE}
                - ${RESULT_IMAGE}
                - ${WORKER_IMAGE}
                
                GitOps repository updated.
                ArgoCD will automatically deploy these new versions.
                
                You can check deployment status in ArgoCD UI.
                """
            }
        }
    }
    
    // ========== POST-BUILD ACTIONS ==========
    post {
        always {
            echo "Cleaning up workspace..."
            cleanWs()  // Clean Jenkins workspace
        }
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs above."
            // You could add email/Slack notification here
        }
    }
}